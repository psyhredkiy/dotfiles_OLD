'use strict';Registry.require("promise statistics helper xmlhttprequest uri convert tools".split(" "),()=>{const x=rea.FEATURES,h=Registry.get("promise");let E,F;const v=Registry.get("uri"),y=Registry.get("helper"),z=Registry.get("convert"),A=Registry.get("tools"),B=Registry.get("statistics");let G;const L=A.createQueue(1),I=f=>{const a=h();z.blob2str(f,(b,g)=>{g?a.reject(g):a.resolve(b)});return a.promise()},p=(f,a)=>(f=(f?f.split("/"):[]).concat(a?[a]:[]).join("/"))?("/"==f.substr(0,1)?"":"/")+
f:"",M=(f,a)=>{a=new a(f);Object.keys(f).forEach(b=>{const g=Object.getOwnPropertyDescriptor(f,b);if(g.get){const r={get:g.get,enumerable:!0};g.set&&(r.set=g.set);Object.defineProperty(a,b,r)}else a[b]=a[b]||f[b]});Object.keys(a).forEach(b=>{const g=Object.getOwnPropertyDescriptor(a,b);g.get||g.set||(f[b]=f[b]||a[b])});f.config=a.config=y.assign(f.config||{},a.config||{});return a},C=function(f){let a={type:f,extend:function(b){return a=M(a,b)},request:function(b){const a=()=>{const a=h(),e=c=>{console.log("rest service: request failed",
c);a.reject(c)},g="xml"===b.responseType,n="headers"===b.responseType;(g||n)&&delete b.responseType;F(b,{onload:function(c){if([200,201,204,207].includes(c.status)){if(g)if(b.anonymous||b.fetch){const d=new window.DOMParser;c.result=d.parseFromString(c.responseText,"text/xml")}else c.result=c.responseXML;else c.result=n?E.parseHeaders(c.responseHeaders):c.response;a.resolve(c)}else e(c)},onerror:e,ontimeout:e,onprogress:a.notify},{internal:!0});return a.promise()};return b.no_queue?a():L.add(a)},
error:function(b){let a=b.status;try{a=a+" | "+b.responseText}catch(r){}B.tC(f,"error","request: "+a)},wait:function(a){return function(){return a.apply(this,arguments).then(a=>a,a=>h.Breach(a?a.responseText||a.statusText:null))}}};return a},D=function(f){const a=f.type;let b=[],g=null,r;const e={config:{auth_prefix:"Bearer"},changes:(()=>{let a;return{listen:function(){a||(a=h(),e.watch&&e.watch.start());return a.promise()},notify:function(c){a.notify(c)}}})(),request:function(a){a.no_auth||(a.headers=
a.headers||{},a.headers.Authorization=e.config.auth_prefix+" "+e.credentials.access_token);return f.request(a)},oauth:(()=>{let b;const c={run:function(){if(r)return r;let d=h();const k=r=d.promise();b="!!"+a+"-"+y.createUUID();let m=e.credentials?e.credentials.refresh_token:null;const q=(a,c)=>{e.credentials=c;d.resolve();d=null;a&&a.close()};(()=>{if(!e.config.refresh_supported||!m)return h.Pledge();const b=h(),d=()=>{m=null;delete e.credentials.refresh_token};F({url:c.getRefreshUrl(m),fetch:!x.RUNTIME.SAFARI},
{onload:function(b){if(b=c.onUrl(b.finalUrl))b.error||!b.access_token?(B.tC(a,"error","auth refresh token: "+(b.error||"!access_token")),d()):q(null,b)},onerror:d,ondone:b.resolve});return b.promise()})().then(()=>{if(d){if(!e.config.refresh_supported)return h.Pledge();var b=h(),l=G({url:c.getRefreshUrl()});l.promise.progress(b=>{let k;d&&(k=c.onUrl(b.url))&&(k.error||!k.access_token?(B.tC(a,"error","auth refresh: "+(k.error||"!access_token")),e.config.refresh_supported=!1):q(l,k))}).always(b.resolve);
return b.promise()}}).then(()=>{if(d){var b=h(),l=G({url:c.getAuthUrl()});l.promise.progress(b=>{let k;d&&(k=c.onUrl(b.url))&&(k.error||!k.access_token?B.tC(a,"error","auth: "+(k.error||"!access_token")):q(l,k))}).always(b.resolve);return b.promise()}}).done(()=>{r=null;d&&d.reject("auth_failed")});return k},getAuthUrl:function(){return e.config.request_uri+"?"+v.hash2params({response_type:e.config.response_type,client_id:e.config.client_id,redirect_uri:e.config.redirect_uri,state:b,scope:e.config.scope})},
getRefreshUrl:function(a){return e.config.redirect_uri+"?"+v.hash2params({client_id:e.config.client_id,redirect_uri:e.config.redirect_uri,state:b,scope:e.config.scope,refresh_token:a})},onUrl:function(a){let c,d;if(a&&0===a.indexOf(e.config.redirect_uri)&&(d=v.parse(a))&&(c=v.params2hash(d))&&(c.access_token||c.error)&&c.state===b)return{uid:c.uid,access_token:c.access_token,refresh_token:c.refresh_token,error:c.error}}};return c})(),wait:function(a){return f.wait(function(){if(e.credentials.access_token)return a.apply(this,
arguments);{const c=arguments,d=h();b.push(function(){d.consume(a.apply(this,c))});e.oauth.run().done(()=>{b.forEach(a=>{a()});b=[]}).fail(a=>{d.reject(a)});return d.promise()}})}},w=x.HTML5.LOCALSTORAGE;Object.defineProperty(e,"credentials",{get:function(){if(null===g){B.tC(a,"init");if(w)try{const a=JSON.parse(w.getItem(e.config.storage_key));g={uid:a.uid,access_token:a.access_token,refresh_token:a.refresh_token}}catch(n){}g=g||{}}return g},set:function(a){if(w)try{w.setItem(e.config.storage_key,
JSON.stringify({uid:a.uid,access_token:a.access_token,refresh_token:a.refresh_token}))}catch(c){}g=a},enumerable:!0});return e},N=function(f){const a=f.type;let b=null;const g={config:{},changes:(()=>{let a;return{listen:function(){a||(a=h(),g.watch&&g.watch.start());return a.promise()},notify:function(b){a.notify(b)}}})(),request:function(a){if(!g.credentials.basic_auth)return h.Breach("Authentication failed");a.no_auth||(a.headers=a.headers||{},a.headers.Authorization="Basic "+g.credentials.basic_auth);
return f.request(a)},wait:function(a){return f.wait(function(){return a.apply(this,arguments)})}};Object.defineProperty(g,"credentials",{get:function(){null===b&&(B.tC(a,"init"),b={basic_auth:g.config.basic_auth});return b},set:function(a){b=a},enumerable:!0});return g},K=function(f){let a,b,g,r,e=null,w=null,n,c,d,k,m;const q=a=>{let b;a&&(b=a.firstChild.nextSibling?a.firstChild.nextSibling:a.firstChild);return b},u=a=>f.wait(function(){const b=arguments;return t.init().then(function(){return a.apply(this,
b)})}),l=(a,b)=>{let c,d;if((c=a.getElementsByTagNameNS("*",b)[0])&&(d=c.firstChild))return d.nodeValue},J=c=>{const d=[];c=c.getElementsByTagNameNS("*","response");for(let m=0;m<c.length;m++){var q=c[m],e=l(q,"href");e=e.replace(/\/$/,"");var k=q.getElementsByTagNameNS("*","propstat")[0].getElementsByTagNameNS("*","prop")[0];q=l(k,"getlastmodified");const O=l(k,"getetag"),u=l(k,"getcontentlength");k=k.getElementsByTagNameNS("*","resourcetype")[0].getElementsByTagNameNS("*","collection")[0];e=e.replace(new RegExp("^("+
[y.escapeForRegExpURL(b+a)+"/?",y.escapeForRegExpURL(g+a)+"/?"].join("|")+")"),"");k||(e={etag:O,name:e,modifiedTime:q?(new Date(q)).getTime():void 0,size:0<=u?u:void 0,removed:-1==u},d.push(e))}return d},H=(a,b)=>{b=b||{};b.set_current_list&&(n={});return t.request({method:"PROPFIND",url:a,headers:{"Content-Type":"text/xml; charset=UTF-8",Depth:void 0!==b.depth?b.depth:1},responseType:"xml"}).then(a=>{a=a.result;var d;if(null===a||!(d=q(a))||!d.childNodes)return h.Breach();a=J(d);b.set_current_list&&
((d=l(d,"td:cursor"))&&(c=d),a.forEach(a=>{n[a.name]=a}));return a})},P=(a,b)=>{const d={"Content-Type":"text/xml; charset=UTF-8",Depth:1,Timeout:90};b&&(d.Cursor=b);return t.request({method:"SUBSCRIBE",url:a,headers:d,responseType:"xml",no_queue:!0}).then(a=>{a=a.result;var b;if(null===a)return h.Pledge({changes:[],cursor:c});if(!(b=q(a))||!b.childNodes)return h.Breach();a=J(b);b=l(b,"td:cursor");return{changes:a,cursor:b}})};var t={config:{watch_interval:36E5},request:function(a){a.headers=a.headers||
{};a.headers["User-Agent"]="Tampermonkey";a.headers.Cookie="";return f.request.apply(this,arguments).then(a=>a,b=>{if(!b||[403,500].includes(b.status))return a.backoff=2*(a.backoff||1E3),A.sleep(a.backoff).then(()=>t.request(a));if(404==b.status)return h.Pledge(b);t.error(b);return h.Breach(b)})},init:function(){if(r)return r;a=p(t.config.root,t.config.path);b=t.config.url||"";"/"==b.slice(-1)&&(b=b.slice(0,-1));g=v.parse(b).pathname;"/"==g.slice(-1)&&(g=g.slice(0,-1));const c=h();r=c.promise();const d=
b+a;t.request({method:"OPTIONS",url:b,responseType:"headers"}).done(a=>{a=a.result;let b;a&&(b=a["access-control-allow-methods"])&&b.includes("EDITOR")&&(m=!0)}).always(()=>{H(d,{depth:0}).done(c.resolve).fail(()=>{const d=[];h.onebyone(a.split("/").filter(a=>a).map(a=>{d.push(a);const c=d.join("/");return()=>t.request({method:"MKCOL",url:b+"/"+c,headers:{"Content-Type":"text/xml; charset=UTF-8"},responseType:"xml"})})).done(c.resolve).fail(c.reject)})});return r},list:u(c=>H(b+a,{set_current_list:!0}).then(a=>
{const b={};return a.map(a=>{if(!c){if(b[a.name])return;b[a.name]=!0}return{name:a.name,size:a.size||0,id:a.id,etag:a.etag,md5:a.md5Checksum,modified:a.modifiedTime,precision:1E3,removed:a.removed}}).filter(a=>a)})),get:u(c=>t.request({method:"GET",url:b+p(a,c.name||c),headers:{"Content-Type":"text/xml; charset=UTF-8"},responseType:"arraybuffer"}).then(a=>new Blob([a.result]))),put:u((c,d,l)=>{const q=c.name||c;let k,m,u;c={"Content-Type":"application/octet-stream"};const g=null===w;l&&l.lastModified&&
(k=l.lastModified,u=(new Date(l.lastModified)).toISOString(),m=l.lastModified/1E3,w||g)&&(c["X-OC-Mtime"]=m);return t.request({method:"PUT",url:b+p(a,q),headers:c,data_type:"typified",data:{type:"raw",value:d},responseType:"headers"}).then(c=>{if((c=c.result)&&g){let a;w="accepted"==c["x-oc-mtime"]||c.date&&(a=(new Date(c.date)).getTime())&&(a==k||a==Math.floor(m))?!0:!1}if(!w&&!e&&u)return t.request({method:"PROPPATCH",url:b+p(a,q),headers:{"Content-Type":"text/xml; charset=UTF-8"},responseType:"xml",
data:['<?xml version="1.0"?><d:propertyupdate xmlns:d="DAV:"><d:set><d:prop>',"<d:getlastmodified>"+u+"</d:getlastmodified>","</d:prop></d:set></d:propertyupdate>"].join("")}).then(a=>{a=a.result;let b,c,d;a&&(b=a.childNodes[0])&&(c=b.getElementsByTagNameNS("*","status")[0])&&(d=c.firstChild.nodeValue)&&-1!=d.search(/HTTP\/[0-9\.]+ 403/)&&(console.warn("WebDAV: no way to set file modification date! This might cause redundant up and downloads."),e=!0)},()=>{console.warn("WebDAV: no way to set file modification date! This might cause redundant up and downloads.");
e=!0})})}),delete:u(c=>t.request({method:"DELETE",url:b+p(a,c.name||c),headers:{"Content-Type":"text/xml; charset=UTF-8"}})),watch:{start:function(){if(!d){d=!0;var l=null,q=()=>{k=null;if(d)if(!1===l){const c=n;H(b+a,{set_current_list:!0}).then(()=>{c&&(Object.keys(c).forEach(a=>{const b=n[a];a=c[a];b?a.modifiedTime!=b.modifiedTime&&f.changes.notify({time:b.modifiedTime,name:b.name}):f.changes.notify({time:Date.now(),name:a.name,removed:!0})}),Object.keys(n).forEach(a=>{c[a]||(a=n[a],f.changes.notify({time:a.modifiedTime,
name:a.name}))}))}).fail(a=>{console.warn("WebDAV: file changes check failed",a)}).always(()=>{k=window.setTimeout(q,t.config.watch_interval)})}else{let d=100;P(b+a,c).then(a=>{const b=a.changes;c=a.cursor;d=1;b.forEach(a=>{f.changes.notify({time:a.modifiedTime,name:a.name,removed:a.removed})})},()=>{if(null===l)l=!1;else return d*=2,A.sleep(d)}).always(q)}};u(()=>{if(!d)return h.Breach();q();return h.Pledge()})()}},stop:function(){d=!1;k&&(window.clearTimeout(k),k=null)}},getRemoteUrl:function(c){if(m)return b+
p(a,c)+"?method=editor#bypass=true"},getRemoteDomains:function(){return[v.parse(b).origin.replace(/^.*:\/\//,"")]}};return t};Registry.register("cloud","289e8b91",{init:function(f,a,b){G=f;E=Registry.get("xmlhttprequest",a,b);F=E.run},drive:function(){let f,a;(f=x.HTML5.LOCALSTORAGE)&&(a=f.getItem("dropbox_poll_interval"))||(a=18E5);return(new C("drive")).extend(D).extend(function(b){let g,f;const e={config:{redirect_uri:"https://auth.tampermonkey.net/oauth.php",refresh_supported:!0,request_uri:"https://accounts.google.com/o/oauth2/v2/auth",
client_id:"408438522028-3cgn3t3jas3fak7isbnfod1q4h15g2fv.apps.googleusercontent.com",storage_key:"gd_config",scope:"https://www.googleapis.com/auth/drive.appdata",response_type:"token",watch_interval:a},request:function(a){return b.request.apply(this,arguments).then(a=>a,b=>{if(!b||[403,500].includes(b.status))return a.backoff=2*(a.backoff||1E3),A.sleep(a.backoff).then(()=>e.request(a));if([400,401].includes(b.status)){if(console.warn("Google Drive: authentication error",b),delete e.credentials.access_token,
!a.retry_auth)return a.retry_auth=!0,e.oauth.run().then(()=>e.request(a))}else if(404==b.status)return h.Pledge(b);e.error(b);return h.Breach(b)})},list:b.wait(a=>{let b=[];const c=h(),d=a=>"https://www.googleapis.com/drive/v3/files?"+v.hash2params({spaces:"appDataFolder",pageToken:a,orderBy:"modifiedTime desc",fields:"nextPageToken, files(id, size, name, modifiedTime, md5Checksum)",pageSize:500}),k=a=>e.request({method:"GET",url:a,headers:{"Content-Type":"application/json"}}).then(a=>{a=(a=a.result)?
JSON.parse(a):{files:[]};b=b.concat(a.files);if(a.nextPageToken)return k(d(a.nextPageToken));c.resolve(b)});k(d());return c.promise().then(b=>{const c={};return b.map(b=>{if(!a){if(c[b.name])return;c[b.name]=!0}return{name:b.name,size:b.size||0,id:b.id,md5:b.md5Checksum,modified:(new Date(b.modifiedTime)).getTime()}}).filter(a=>a)})}),get:b.wait(a=>e.request({method:"GET",url:"https://www.googleapis.com/drive/v3/files/"+(a.id||a)+"?"+v.hash2params({spaces:"appDataFolder",alt:"media"}),responseType:"arraybuffer"}).then(a=>
new Blob([a.result]))),put:b.wait((a,b,c)=>{const d=a.name||a,k=a.id,m=y.createUUID();return h.Pledge().then(()=>{if(b)return I(b)}).then(a=>{const b=c&&c.lastModified?(new Date(c.lastModified)).toISOString():void 0,l=[];l.push("--"+m);l.push("Content-Type: application/json");l.push("");l.push(JSON.stringify({name:d,parents:k?void 0:["appDataFolder"],modifiedTime:b}));l.push("--"+m);a&&(l.push("Content-Type: application/octet-stream"),l.push("Content-Transfer-Encoding: base64"),l.push(""),l.push(z.Base64.encode(a)),
l.push("--"+m+"--"));l.push("");return e.request({method:k||!a?"PATCH":"POST",url:"https://www.googleapis.com/"+(a?"upload/":"")+"drive/v3/files"+(k?"/"+k:"")+"?"+v.hash2params({uploadType:"multipart"}),headers:{"Content-Type":"multipart/related; boundary="+m},data:l.join("\r\n")})})}),delete:b.wait(a=>e.request({method:"DELETE",url:"https://www.googleapis.com/drive/v3/files/"+(a.id||a)+"?"+v.hash2params({spaces:"appDataFolder"}),headers:{"Content-Type":" application/json"}})),revoke:b.wait(()=>{const a=
e.credentials.access_token;return a?b.request({method:"GET",url:"https://accounts.google.com/o/oauth2/revoke?"+v.hash2params({token:a})}):h.Breach()}),compare:function(a,b){const c=h();let d;(d=a.md5)&&d==z.MD5(b,"utf-8")?c.resolve(!0):c.resolve(!1);return c.promise()},watch:{start:function(){if(!g){g=!0;var a,n=()=>{f=null;g&&e.request({method:"GET",url:"https://www.googleapis.com/drive/v3/changes/?"+v.hash2params({pageToken:a,spaces:"appDataFolder",pageSize:1E3,includeRemoved:!0}),headers:{"Content-Type":" application/json"}}).then(c=>
{c=c.result;if(!g)return h.Breach();const d=c?JSON.parse(c):{};if(!(a=d.newStartPageToken))return console.warn("Google Drive: watch token error",c),e.watch.stop();d.nextPageToken&&console.warn("Google Drive: too much changes",c);(d.changes||[]).forEach(a=>{let c,d;"file"===a.type&&(d=a.file)&&(c=Date.parse(a.time),isNaN(c)&&(c=Date.now()),b.changes.notify({id:d.id,time:c,name:d.name,removed:a.removed}))})}).fail(a=>{console.warn("Google Drive: file changes check failed",a)}).always(()=>{f=window.setTimeout(n,
e.config.watch_interval)})};b.wait(()=>g?e.request({method:"GET",url:"https://www.googleapis.com/drive/v3/changes/startPageToken",headers:{"Content-Type":" application/json"}}).then(b=>{b=b.result;if(!(a=(b?JSON.parse(b):{}).startPageToken))return console.warn("Google Drive: watch token error",b),e.watch.stop();n()}):h.Breach())()}},stop:function(){g=!1;f&&(window.clearTimeout(f),f=null)}}};return e})},dropbox:function(f){const a=f.path||"";let b,g;(b=x.HTML5.LOCALSTORAGE)&&(g=b.getItem("dropbox_poll_interval"))||
(g=18E5);return(new C("dropbox")).extend(D).extend(function(b){let e,f,n,c,d=!0;const k=b=>{let c=[];const l=h(),e=b=>m.request({method:"POST",url:"https://api.dropboxapi.com/2/files/list_folder"+(b?"/continue":""),headers:{"Content-Type":" application/json"},data:{path:b?void 0:p(a),cursor:b}}).then(a=>{a=(a=a.result)?JSON.parse(a):{entries:[]};c=c.concat(a.entries);if(a.has_more&&a.cursor)return e(a.cursor);l.resolve({list:c,cursor:a.cursor})}).fail(l.reject);d?(d=!1,m.put(".version",new Blob([rea.extension.manifest.version])).then(()=>
{e(b)}).fail(l.reject)):e(b);return l.promise()};var m={config:{redirect_uri:"https://auth.tampermonkey.net/oauth.php",request_uri:"https://www.dropbox.com/oauth2/authorize",client_id:"gq3auc9yym0e21y",storage_key:"db_config",response_type:"token",watch_interval:g},request:function(a){return b.request.apply(this,arguments).then(a=>a,b=>{if(!b||[500,429].includes(b.status))return a.backoff=2*(a.backoff||1E3),A.sleep(a.backoff).then(()=>m.request(a));if([401].includes(b.status)&&(console.warn("Dropbox: authentication error",
b),delete m.credentials.access_token,!a.retry_auth))return a.retry_auth=!0,m.oauth.run().then(()=>m.request(a));m.error(b);return h.Breach(b)})},list:b.wait(a=>k().then(b=>{const d={};c=b.cursor;return b.list.map(b=>{if(!a){if(d[b.name])return;d[b.name]=!0}return{name:b.name,size:b.size,dropbox_hash:b.content_hash,modified:(new Date(b.client_modified)).getTime(),precision:1E3}}).filter(a=>a)}).always(()=>{n&&c&&(n(),n=null)})),get:b.wait(b=>m.request({method:"POST",url:"https://content.dropboxapi.com/2/files/download",
headers:{"Dropbox-API-Arg":JSON.stringify({path:p(a,b.name||b)})},responseType:"arraybuffer"}).then(a=>new Blob([a.result]))),put:b.wait((b,c,d)=>{b=b.name||b;d=d&&d.lastModified?(new Date(d.lastModified)).toISOString().match(/[^:]*:[^:]*:[^:.a-zA_Z]*/)[0]+"Z":void 0;return m.request({method:"POST",url:"https://content.dropboxapi.com/2/files/upload",headers:{"Dropbox-API-Arg":JSON.stringify({path:p(a,b),client_modified:d,mode:"overwrite"}),"Content-Type":"application/octet-stream"},data_type:"typified",
data:{type:"raw",value:c}})}),delete:b.wait(b=>m.request({method:"POST",url:"https://api.dropboxapi.com/2/files/delete",headers:{"Content-Type":" application/json"},data:{path:p(a,b.name||b)}})),compare:function(a,b){const c=h();if(window.crypto&&window.ArrayBuffer){const d=z.str2arrbuf(b,"utf-8"),e=[],l=d.byteLength;let k=1;const f=()=>{if(0===--k){let b=new window.ArrayBuffer;e.forEach(a=>{{var c=b;const d=new Uint8Array(c.byteLength+a.byteLength);d.set(new Uint8Array(c),0);d.set(new Uint8Array(a),
c.byteLength);b=d.buffer}});window.crypto.subtle.digest("SHA-256",b).then(b=>{b=Array.from(new Uint8Array(b)).map(a=>("00"+a.toString(16)).slice(-2)).join("");c.resolve(b==a.dropbox_hash)})}};for(let a=0,b=0;b<l;b+=4194304,a++)(a=>{e.push(null);k++;window.crypto.subtle.digest("SHA-256",d.slice(b,b+Math.min(4194304,l-b))).then(b=>{e[a]=b;f()},()=>{console.warn("Dropbox: unable to calculate SHA-256 hashes");c.reject()})})(a);f()}else console.warn("Dropbox: unable to calculate SHA-256 hashes"),c.reject();
return c.promise()},watch:{start:function(){if(!e){e=!0;var a=0,d=()=>{f=null;a=0;if(e){if(!c)return console.warn("Dropbox: watch token error",c),m.watch.stop();m.request({method:"POST",url:"https://notify.dropboxapi.com/2/files/list_folder/longpoll",headers:{"Content-Type":" application/json"},no_auth:!0,no_queue:!0,data:{cursor:c,timeout:180}}).then(b=>{const d=b.result;if(!e)return h.Breach();b=d?JSON.parse(d):{};b.backoff&&(a=1E3*b.backoff);return b.changes?A.sleep(6E4).then(()=>k(c)).then(a=>
(c=a.cursor)?a.list:(console.warn("Dropbox: watch token error",d),m.watch.stop())):null}).then(a=>{a&&a.forEach(a=>{let c;const d=a[".tag"];["file","deleted"].includes(d)&&(c=Date.parse(a.server_modified),b.changes.notify({id:a.id,time:c,name:a.name,removed:"deleted"==d}))})}).fail(a=>{console.warn("Dropbox: file changes check failed",a)}).always(()=>{f=window.setTimeout(d,a+m.config.watch_interval)})}};b.wait(()=>{if(!e)return h.Breach();c?d():n=d;return h.Pledge()})()}},stop:function(){e=!1;f&&
(window.clearTimeout(f),f=null)}},getRemoteDomains:function(){return["dropbox.com","dropboxapi.com"]}};return m})},onedrive:function(f){const a=f.path||"";let b,g,r;(b=x.HTML5.LOCALSTORAGE)&&(g=b.getItem("onedrive_poll_interval"))||(g=18E5);return(new C("onedrive")).extend(D).extend(function(b){let e,f;const c=b=>{const c=h();let e=[];const k=f=>d.request({method:"GET",url:f||"https://api.onedrive.com/v1.0/drive/special/approot:"+p(a)+":/children",headers:{"Content-Type":" application/json"}}).then(a=>
{a=(a=a.result)?JSON.parse(a):{value:[]};e=e.concat(a.value.map(a=>({id:a.id,name:a.name,size:a.size,sha1:a.file&&a.file.hashes?a.file.hashes.sha1Hash:void 0,modified:(new Date((a.fileSystemInfo?a.fileSystemInfo.lastModifiedDateTime:null)||a.lastModifiedDateTime)).getTime()})));if(a["@odata.nextLink"])return k(a["@odata.nextLink"]);b.set_current_list&&(r=e);c.resolve(e)});k();return c.promise()};var d={config:{redirect_uri:"https://auth.tampermonkey.net/oauth.php",request_uri:"https://login.live.com/oauth20_authorize.srf",
client_id:"000000004C1A3122",storage_key:"od_config",response_type:"token",scope:"onedrive.appfolder",watch_interval:g},getRemoteDomains:function(){return["onedrive.live.com"]},request:function(a){return b.request.apply(this,arguments).then(a=>a,b=>{if(!b)return console.warn("OneDrive: timeout"),h.Breach("Timeout");if([401].includes(b.status)){if(console.warn("OneDrive: authentication error",b),delete d.credentials.access_token,!a.retry_auth)return a.retry_auth=!0,d.oauth.run().then(()=>d.request(a))}else if(404==
b.status)return h.Pledge(b);d.error(b);return h.Breach(b)})},list:b.wait(()=>c({set_current_list:!0})),get:b.wait(b=>d.request({method:"GET",url:"https://api.onedrive.com/v1.0/drive/special/approot:"+p(a,encodeURIComponent(b.name||b))+":/content",responseType:"arraybuffer"}).then(a=>new Blob([a.result]))),put:b.wait((b,c,e)=>{b=encodeURIComponent((b.name||b).replace(/[#%<>:"|\?\*\/\\]/g,"-"));return d.request({method:"PUT",url:"https://api.onedrive.com/v1.0/drive/special/approot:"+p(a,b)+":/content",
headers:{"Content-Type":"application/octet-stream"},data_type:"typified",data:{type:"raw",value:c}}).then(a=>{const b=e&&e.lastModified?(new Date(e.lastModified)).toISOString():void 0;if(!b)return a;a=JSON.parse(a.result);return d.request({method:"PATCH",url:"https://api.onedrive.com/v1.0/drive/items/"+a.id,headers:{"Content-Type":"application/json"},data:JSON.stringify({fileSystemInfo:{lastModifiedDateTime:b}})})})}),delete:b.wait(b=>d.request({method:"DELETE",url:"https://api.onedrive.com/v1.0/drive/special/approot:"+
p(a,encodeURIComponent(b.name||b))})),watch:{start:function(){if(!e){e=!0;var a=()=>{f=null;if(e){var g=r;c({set_current_list:!0}).then(()=>{if(g){var a={},c={};r.forEach(b=>{a[b.id]=b});g.forEach(a=>{c[a.id]=a});Object.keys(c).forEach(d=>{const e=a[d];d=c[d];e?d.modified!=e.modified&&b.changes.notify({time:e.modified,name:e.name}):b.changes.notify({time:Date.now(),name:d.name,removed:!0})});Object.keys(a).forEach(d=>{c[d]||(d=a[d],b.changes.notify({time:d.modified,name:d.name}))})}}).fail(a=>{console.warn("OneDrive: file changes check failed",
a)}).always(()=>{f=window.setTimeout(a,d.config.watch_interval)})}};d.wait(()=>{if(!e)return h.Breach();a();return h.Pledge()})()}},stop:function(){e=!1;f&&(window.clearTimeout(f),f=null)}}};return d})},yandex:function(f){let a,b;(a=x.HTML5.LOCALSTORAGE)&&(b=a.getItem("yandex_poll_interval"))||(b=18E5);return(new C("yandex")).extend(D).extend(K).extend(function(a){const g=a.request;a.request=a=>(()=>{a.headers["X-Requested-With"]="XMLHttpRequest";if(window.forge_sha256&&"PUT"==a.method&&a.data&&"raw"==
a.data.type&&a.data.value){const b=h();I(a.data.value).then(b=>{a.headers.Etag=z.MD5(b);a.headers.Sha256=window.forge_sha256(b)}).always(b.resolve);return b.promise()}return h.Pledge()})().then(()=>g(a).then(a=>a,b=>b&&[401].includes(b.status)&&(console.warn("Yandex: authentication error",b),delete n.credentials.access_token,!a.retry_auth)?(a.retry_auth=!0,n.oauth.run().then(()=>g(a))):b));const e=a.init;let p;a.init=()=>{if(p)return p;const a=h();p=a.promise();n.request({method:"GET",url:"https://cloud-api.yandex.net/v1/disk/"}).done(a=>
{a=(a=a.result)?JSON.parse(a):{};a.total_space&&a.used_space&&(a.used_space+5E7>a.total_space?console.warn("Yandex: low disk space warning, only "+(a.total_space-a.used_space)+" bytes available"):console.log("Yandex: "+(a.total_space-a.used_space)+" bytes on disk available!"))}).always(()=>{a.consume(e())});return p};var n={config:y.assign({root:"/Programs/Tampermonkey",url:"https://webdav.yandex.ru",redirect_uri:"https://auth.tampermonkey.net/oauth.php",refresh_supported:!0,request_uri:"https://oauth.yandex.com/authorize",
client_id:"a591fcd2ccd248f0baa84222898065f4",storage_key:"ya_config",response_type:"token",auth_prefix:"OAuth",watch_interval:b},f),getRemoteDomains:function(){return["disk.yandex.com"]},list:function(b){return a.list(b).then(a=>a.map(a=>{a.md5=a.etag;return a}))},compare:function(a,b){const c=h();let d;(d=a.md5)&&d==z.MD5(b,"utf-8")?c.resolve(!0):c.resolve(!1);return c.promise()}};return n})},webdav:function(f){var a;let b;(a=x.HTML5.LOCALSTORAGE)&&(b=a.getItem("webdav_poll_interval"))||(b=18E5);
if(a=f.url){var g=a.toLowerCase();g.startsWith("webdav")?f.url=a.replace(/^webdav/i,"http"):g.startsWith("http")||(f.url=`http://${a}`)}return(new C("webdav")).extend(N).extend(K).extend(function(){return{config:y.assign({root:"Tampermonkey",watch_interval:b},f)}})}})});
